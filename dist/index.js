import{attribute as P}from"datastar";import{effect as h,getPath as b,mergePatch as d,beginBatch as m,endBatch as y}from"datastar";var i="datastar";function S(s){try{let e=s?sessionStorage:localStorage,n="__test__";return e.setItem(n,"1"),e.removeItem(n),e}catch{return null}}function E(s,e,n,o){let t=n.has("session"),l=S(t);if(!l)return null;let g=s?`${i}-${s}`:i,r=[],a=!1,c=e;(e==null||typeof e!="string")&&(c=o.getAttribute("data-persist")||o.getAttribute("data-persist:"+(s||""))||"");let u=typeof c=="string"?c.trim():"";return u?r=u.split(",").map(p=>p.trim()).filter(Boolean):a=!0,{storage:l,storageKey:g,signals:r,isWildcard:a}}function O(s){try{let e=s.storage.getItem(s.storageKey);if(!e)return;let n=JSON.parse(e);if(!n||typeof n!="object")return;m();try{if(s.isWildcard)d(n);else{let o=Object.fromEntries(s.signals.filter(t=>t in n).map(t=>[t,n[t]]));Object.keys(o).length>0&&d(o)}}finally{y()}}catch{}}function A(s){let e=[];for(let o of s.attributes)if(o.name.startsWith("data-signals:")){let t=o.name.substring(13);t&&e.push(t)}let n=s.getAttribute("data-signals");if(n)try{let o=n.matchAll(/(\w+)\s*:/g);for(let t of o)t[1]&&!e.includes(t[1])&&e.push(t[1])}catch{}return e}function K(s,e){try{let n=s.storage.getItem(s.storageKey),t={...n?JSON.parse(n):{},...e};Object.keys(t).length>0&&s.storage.setItem(s.storageKey,JSON.stringify(t))}catch{}}console.log("[Persist Plugin] Loaded");var f=new Set;(function(){console.log("[Persist Plugin] Attempting early load from storage");try{let n=localStorage.getItem(i);if(n){console.log("[Persist Plugin] Found persisted data:",n);let o=JSON.parse(n);if(o&&typeof o=="object"&&Object.keys(o).length>0){console.log("[Persist Plugin] Restoring signals:",Object.keys(o)),m();try{d(o),f.add(i),console.log("[Persist Plugin] \u2713 Persisted values restored early")}finally{y()}}}else console.log("[Persist Plugin] No persisted data found")}catch(e){console.warn("[Persist Plugin] Early load failed:",e)}})();P({name:"persist",requirement:"optional",apply({el:s,key:e,mods:n,value:o}){console.log("[Persist Plugin] Apply called",{el:s,key:e,value:o});let t=E(e??null,o,n,s);if(!t){console.warn("[Persist Plugin] No config");return}return console.log("[Persist Plugin] Config:",t),f.has(t.storageKey)?console.log("[Persist Plugin] Already loaded (using early-loaded values)"):(console.log("[Persist Plugin] Loading from storage"),O(t),f.add(t.storageKey)),h(()=>{let g=t.isWildcard?A(s):t.signals,r={};for(let a of g)try{r[a]=b(a)}catch{}Object.keys(r).length>0&&K(t,r)})}});
