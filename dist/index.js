import{attribute as d}from"datastar";import{effect as p,getPath as y,mergePatch as f,beginBatch as h,endBatch as b}from"datastar";var u="datastar";function P(e){try{let s=e?sessionStorage:localStorage,n="__test__";return s.setItem(n,"1"),s.removeItem(n),s}catch{return null}}function S(e,s,n,r){let t=n.has("session"),a=P(t);if(!a)return null;let g=e?`${u}-${e}`:u,i=[],o=!1,l=s;(s==null||typeof s!="string")&&(l=r.getAttribute("data-persist")||r.getAttribute("data-persist:"+(e||""))||"");let c=typeof l=="string"?l.trim():"";return c?i=c.split(",").map(m=>m.trim()).filter(Boolean):o=!0,{storage:a,storageKey:g,signals:i,isWildcard:o}}function E(e){try{let s=e.storage.getItem(e.storageKey);if(!s)return;let n=JSON.parse(s);if(!n||typeof n!="object")return;h();try{if(e.isWildcard)f(n);else{let r=Object.fromEntries(e.signals.filter(t=>t in n).map(t=>[t,n[t]]));Object.keys(r).length>0&&f(r)}}finally{b()}}catch{}}function A(e){let s=[];for(let r of e.attributes)if(r.name.startsWith("data-signals:")){let t=r.name.substring(13);t&&s.push(t)}let n=e.getAttribute("data-signals");if(n)try{let r=n.matchAll(/(\w+)\s*:/g);for(let t of r)t[1]&&!s.includes(t[1])&&s.push(t[1])}catch{}return s}function O(e,s){try{let n=e.storage.getItem(e.storageKey),t={...n?JSON.parse(n):{},...s};Object.keys(t).length>0&&e.storage.setItem(e.storageKey,JSON.stringify(t))}catch{}}console.log("[Persist Plugin] Loaded");d({name:"persist",requirement:"optional",apply({el:e,key:s,mods:n,value:r}){console.log("[Persist Plugin] Apply called",{el:e,key:s,value:r});let t=S(s??null,r,n,e);if(!t){console.warn("[Persist Plugin] No config");return}return console.log("[Persist Plugin] Config:",t),E(t),p(()=>{let g=t.isWildcard?A(e):t.signals,i={};for(let o of g)try{i[o]=y(o)}catch{}Object.keys(i).length>0&&O(t,i)})}});
